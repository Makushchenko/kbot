name: CI/CD kbot
run-name: ${{ github.triggering_actor }} is triggered "${{ github.workflow }}" workflow

on:
  push:
    branches:
      - develop

env:
  REGISTRY: ghcr.io

permissions:
  contents: write

jobs:
  ci:
    name: CI
    runs-on: ubuntu-latest
    steps:
      - 
        name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0        
      - 
        name: Run test
        run: make test
      -
        name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GH_TOKEN }}
      - 
        name: Build & Push
        run: make image push
  cd:
    name: CD
    needs: ci
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0 
    - run: echo "VERSION=$(git describe --tags --abbrev=0)-$(git rev-parse --short HEAD)" >> $GITHUB_ENV
    - uses: mikefarah/yq@master
      with:
        cmd: yq -i '.image.tag=strenv(VERSION)' helm/kbot/values.yaml
    - run: |
        git config user.name github-actions
        git config user.email github-actions@github.com
        git commit -am "set image tag to ${VERSION}"
        git push origin ${{ github.ref_name }}