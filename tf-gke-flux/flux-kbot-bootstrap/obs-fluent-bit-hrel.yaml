apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: fluent-bit
  namespace: observability
spec:
  interval: 10m
  chart:
    spec:
      chart: fluent-bit
      version: ">=0.50.0"
      sourceRef:
        kind: HelmRepository
        name: fluent
        namespace: flux-system
  values:
    serviceAccount:
      automountServiceAccountToken: true
    securityContext:
      runAsNonRoot: true
      readOnlyRootFilesystem: true
    extraVolumes:
      - name: runlog
        hostPath: { path: /run/log/journal }
      - name: varlogjournal
        hostPath: { path: /var/log/journal }
    extraVolumeMounts:
      - name: runlog
        mountPath: /run/log/journal
        readOnly: true
      - name: varlogjournal
        mountPath: /var/log/journal
        readOnly: true
    config:
      inputs: |
        [INPUT]
          Name  systemd
          Tag   node.*
          DB    /var/log/flb-systemd.db
          Strip_Underscores On
          Systemd_Filter _SYSTEMD_UNIT=kubelet.service
          Systemd_Filter _SYSTEMD_UNIT=containerd.service      
      config:
        service: |
          [SERVICE]
            Parsers_File  parsers.conf
            HTTP_Server   On
            HTTP_Listen   0.0.0.0
            HTTP_Port     2020
        inputs: |
          [INPUT]
            Name              tail
            Path              /var/log/containers/*.log
            Parser            cri
            Tag               kube.*
            Mem_Buf_Limit     5MB
            Skip_Long_Lines   On
        filters: |
          [FILTER]
            Name                kubernetes
            Match               kube.*
            Merge_Log           On
            Keep_Log            Off
            Kube_Tag_Prefix     kube.var.log.containers.
        outputs: |
          [OUTPUT]
            Name       opentelemetry
            Match      kube.*
            Host       otel-gateway.observability.svc.cluster.local
            Port       4318
            logs_uri   /v1/logs
            metrics_uri /v1/metrics
            traces_uri /v1/traces
            tls        Off
            tls.verify Off